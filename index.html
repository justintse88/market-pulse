<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Pulse</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://momentjs.com/downloads/moment-timezone-with-data.js"></script>
    <style>
        body {
            background-color: #02070d;
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        table {
            width: 100%;
            max-width: 100vw;
            border-collapse: collapse;
            font-size: clamp(2rem, 5vw, 3rem);
            color: #fff;
        }
        td {
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }
        .closed { color: yellow; }
        .open { color: limegreen; }
    </style>
</head>
<body>
    <table>
        <tr>
            <td>NYSE</td>
            <td id="nyse-countdown"></td>
        </tr>
        <tr>
            <td>LSE</td>
            <td id="lse-countdown"></td>
        </tr>
        <tr>
            <td>USD.HKD</td>
            <td id="usdhkd"></td>
        </tr>
        <tr>
            <td>USD 1D</td>
            <td id="effr"></td>
        </tr>
        <tr>
            <td>HKD 1D</td>
            <td id="hkd_on"></td>
        </tr>
        <tr>
            <td>HKD 1M</td>
            <td id="hkd_1m"></td>
        </tr>
    </table>

    <script>
        const nyseConfig = {
            tz: 'America/New_York',
            openTime: '09:30',
            closeTime: '16:00',
            holidays: [],
            earlyCloses: {}
        };

        const lseConfig = {
            tz: 'Europe/London',
            openTime: '08:00',
            closeTime: '16:30',
            holidays: [],
            earlyCloses: {}
        };

        function isHoliday(date, holidays) {
            return holidays.includes(date.format('YYYY-MM-DD'));
        }

        function isWeekend(date) {
            return date.isoWeekday() > 5;
        }

        function getCloseTime(date, earlyCloses, closeTime) {
            const dateStr = date.format('YYYY-MM-DD');
            return earlyCloses[dateStr] || closeTime;
        }

        function getNextTradingDay(current, config) {
            let next = current.clone().add(1, 'day');
            while (isWeekend(next) || isHoliday(next, config.holidays)) {
                next.add(1, 'day');
            }
            return next;
        }

        function formatDuration(diff) {
            const duration = moment.duration(diff);
            const hours = Math.floor(duration.asHours()).toString().padStart(2, '0');
            const minutes = duration.minutes().toString().padStart(2, '0');
            const seconds = duration.seconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateTimer(config, countdownId) {
            const now = moment.tz(config.tz);
            const isTodayHoliday = isHoliday(now, config.holidays);
            const isTodayWeekend = isWeekend(now);

            if (isTodayHoliday || isTodayWeekend) {
                const nextOpen = getNextTradingDay(now, config);
                const openMoment = nextOpen.clone().set({ hour: config.openTime.split(':')[0], minute: config.openTime.split(':')[1], second: 0 });
                const diff = openMoment.diff(now);
                document.getElementById(countdownId).className = 'closed';
                document.getElementById(countdownId).textContent = formatDuration(diff);
                return;
            }

            const openMoment = now.clone().set({ hour: config.openTime.split(':')[0], minute: config.openTime.split(':')[1], second: 0 });
            const closeTime = getCloseTime(now, config.earlyCloses, config.closeTime);
            const closeMoment = now.clone().set({ hour: closeTime.split(':')[0], minute: closeTime.split(':')[1], second: 0 });

            if (now.isBefore(openMoment)) {
                const diff = openMoment.diff(now);
                document.getElementById(countdownId).className = 'closed';
                document.getElementById(countdownId).textContent = formatDuration(diff);
            } else if (now.isBefore(closeMoment)) {
                const diff = closeMoment.diff(now);
                document.getElementById(countdownId).className = 'open';
                document.getElementById(countdownId).textContent = formatDuration(diff);
            } else {
                const nextOpen = getNextTradingDay(now, config);
                const openMomentNext = nextOpen.clone().set({ hour: config.openTime.split(':')[0], minute: config.openTime.split(':')[1], second: 0 });
                const diff = openMomentNext.diff(now);
                document.getElementById(countdownId).className = 'closed';
                document.getElementById(countdownId).textContent = formatDuration(diff);
            }
        }

        function getEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return moment([year, month - 1, day]);
        }

        function observeDate(date) {
            let d = moment(date);
            const wd = d.isoWeekday();
            if (wd === 6) d.subtract(1, 'day');
            if (wd === 7) d.add(1, 'day');
            return d.format('YYYY-MM-DD');
        }

        function getNthWeekday(year, month, weekday, n) {
            let date = moment([year, month - 1, 1]);
            while (date.isoWeekday() !== weekday) {
                date.add(1, 'day');
            }
            date.add(n - 1, 'weeks');
            return date.format('YYYY-MM-DD');
        }

        function getLastWeekday(year, month, weekday) {
            let date = moment([year, month - 1]).endOf('month');
            while (date.isoWeekday() !== weekday) {
                date.subtract(1, 'day');
            }
            return date.format('YYYY-MM-DD');
        }

        function calculateHolidays(year) {
            const easter = getEaster(year);
            const goodFriday = easter.clone().subtract(2, 'days').format('YYYY-MM-DD');
            const easterMonday = easter.clone().add(1, 'day').format('YYYY-MM-DD');

            // NYSE Holidays
            nyseConfig.holidays = [
                observeDate(moment([year, 0, 1])), // New Year's
                getNthWeekday(year, 1, 1, 3), // MLK, Monday=1
                getNthWeekday(year, 2, 1, 3), // Presidents
                goodFriday,
                getLastWeekday(year, 5, 1), // Memorial
                observeDate(moment([year, 5, 19])), // Juneteenth
                observeDate(moment([year, 6, 4])), // Independence
                getNthWeekday(year, 9, 1, 1), // Labor
                getNthWeekday(year, 11, 4, 4), // Thanksgiving, Thursday=4
                observeDate(moment([year, 11, 25])) // Christmas
            ];

            const independence = moment([year, 6, 4]);
            const independenceEve = independence.clone().subtract(1, 'day');
            if (!isWeekend(independenceEve)) {
                nyseConfig.earlyCloses[independenceEve.format('YYYY-MM-DD')] = '13:00';
            }

            const thanksgiving = moment(nyseConfig.holidays.find(h => h.startsWith(year + '-11')));
            const blackFriday = moment(thanksgiving).add(1, 'day');
            if (!isWeekend(blackFriday)) {
                nyseConfig.earlyCloses[blackFriday.format('YYYY-MM-DD')] = '13:00';
            }

            const christmas = moment([year, 11, 25]);
            const christmasEve = christmas.clone().subtract(1, 'day');
            if (!isWeekend(christmasEve)) {
                nyseConfig.earlyCloses[christmasEve.format('YYYY-MM-DD')] = '13:00';
            }

            // LSE Holidays
            lseConfig.holidays = [
                observeDate(moment([year, 0, 1])), // New Year's
                goodFriday,
                easterMonday,
                getNthWeekday(year, 5, 1, 1), // Early May
                getLastWeekday(year, 5, 1), // Spring
                getLastWeekday(year, 8, 1), // Summer
                observeDate(moment([year, 11, 25])), // Christmas
                observeDate(moment([year, 11, 26])) // Boxing
            ];

            const newYearsEve = moment([year, 11, 31]);
            if (!isWeekend(newYearsEve)) {
                lseConfig.earlyCloses[newYearsEve.format('YYYY-MM-DD')] = '12:30';
            }

            if (!isWeekend(christmasEve)) {
                lseConfig.earlyCloses[christmasEve.format('YYYY-MM-DD')] = '12:30';
            }
        }

        async function updateRates() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await res.json();
                document.getElementById('usdhkd').textContent = data.rates.HKD.toFixed(4);
            } catch {
                document.getElementById('usdhkd').textContent = 'N/A';
            }

            try {
                const res = await fetch('https://markets.newyorkfed.org/api/rates/all/latest.xml');
                const xmlText = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                const rates = xml.getElementsByTagName('rate');
                for (let rate of rates) {
                    if (rate.getElementsByTagName('type')[0].textContent === 'EFFR') {
                        const percentRate = parseFloat(rate.getElementsByTagName('percentRate')[0].textContent).toFixed(2);
                        document.getElementById('effr').textContent = percentRate + '%';
                        break;
                    }
                }
            } catch {
                document.getElementById('effr').textContent = 'N/A';
            }

            try {
                const res = await fetch('https://api.hkma.gov.hk/public/market-data-and-statistics/daily-monetary-statistics/daily-figures-interbank-liquidity');
                const data = await res.json();
                const latest = data.result.records[0];
                document.getElementById('hkd_on').textContent = parseFloat(latest.hibor_overnight).toFixed(2) + '%';
                document.getElementById('hkd_1m').textContent = parseFloat(latest.hibor_fixing_1m).toFixed(2) + '%';
            } catch {
                document.getElementById('hkd_on').textContent = 'N/A';
                document.getElementById('hkd_1m').textContent = 'N/A';
            }
        }

        function updateTimers() {
            updateTimer(nyseConfig, 'nyse-countdown');
            updateTimer(lseConfig, 'lse-countdown');
        }

        function init() {
            const year = moment().year();
            calculateHolidays(year);
            updateRates();
            updateTimers();
        }

        init();
        setInterval(updateTimers, 1000);
        setInterval(updateRates, 3600000); // every 1 hour
        setInterval(() => calculateHolidays(moment().year()), 86400000); // every 24 hours
    </script>
</body>
</html>
