<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Pulse</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://momentjs.com/downloads/moment-timezone-with-data.js"></script>
    <style>
        body {
            background-color: #02070d;
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        table {
            width: 100%;
            max-width: 100vw;
            border-collapse: collapse;
            font-size: clamp(2rem, 5vw, 3rem);
            color: #fff;
        }
        td {
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }
        .closed { color: yellow; }
        .open { color: limegreen; }
    </style>
</head>
<body>
    <table>
        <tr>
            <td>NYSE</td>
            <td id="nyse-countdown"></td>
        </tr>
        <tr>
            <td>LSE</td>
            <td id="lse-countdown"></td>
        </tr>
        <tr>
            <td>USD.HKD</td>
            <td id="usdhkd"></td>
        </tr>
        <tr>
            <td>USD 1D</td>
            <td id="effr"></td>
        </tr>
        <tr>
            <td>HKD 1D</td>
            <td id="hkd_on"></td>
        </tr>
        <tr>
            <td>HKD 1M</td>
            <td id="hkd_1m"></td>
        </tr>
    </table>

    <script>
        const nyseConfig = {
            tz: 'America/New_York',
            openTime: '09:30',
            closeTime: '16:00',
            holidays: ['2025-01-01', '2025-01-20', '2025-02-17', '2025-04-18', '2025-05-26', '2025-06-19', '2025-07-04', '2025-09-01', '2025-11-27', '2025-12-25'],
            earlyCloses: { '2025-07-03': '13:00', '2025-11-28': '13:00', '2025-12-24': '13:00' }
        };

        const lseConfig = {
            tz: 'Europe/London',
            openTime: '08:00',
            closeTime: '16:30',
            holidays: ['2025-01-01', '2025-04-18', '2025-04-21', '2025-05-05', '2025-05-26', '2025-08-25', '2025-12-25', '2025-12-26'],
            earlyCloses: { '2025-12-24': '12:30', '2025-12-31': '12:30' }
        };

        function isHoliday(date, holidays) {
            return holidays.includes(date.format('YYYY-MM-DD'));
        }

        function isWeekend(date) {
            return date.isoWeekday() > 5;
        }

        function getCloseTime(date, earlyCloses, closeTime) {
            const dateStr = date.format('YYYY-MM-DD');
            return earlyCloses[dateStr] || closeTime;
        }

        function getNextTradingDay(current, config) {
            let next = current.clone().add(1, 'day');
            while (isWeekend(next) || isHoliday(next, config.holidays)) {
                next.add(1, 'day');
            }
            return next;
        }

        function formatDuration(diff) {
            const duration = moment.duration(diff);
            const hours = Math.floor(duration.asHours()).toString().padStart(2, '0');
            const minutes = duration.minutes().toString().padStart(2, '0');
            const seconds = duration.seconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateTimer(config, countdownId) {
            const now = moment.tz(config.tz);
            const isTodayHoliday = isHoliday(now, config.holidays);
            const isTodayWeekend = isWeekend(now);

            if (isTodayHoliday || isTodayWeekend) {
                const nextOpen = getNextTradingDay(now, config);
                const openMoment = nextOpen.clone().set({ hour: config.openTime.split(':')[0], minute: config.openTime.split(':')[1], second: 0 });
                const diff = openMoment.diff(now);
                document.getElementById(countdownId).className = 'closed';
                document.getElementById(countdownId).textContent = formatDuration(diff);
                return;
            }

            const openMoment = now.clone().set({ hour: config.openTime.split(':')[0], minute: config.openTime.split(':')[1], second: 0 });
            const closeTime = getCloseTime(now, config.earlyCloses, config.closeTime);
            const closeMoment = now.clone().set({ hour: closeTime.split(':')[0], minute: closeTime.split(':')[1], second: 0 });

            if (now.isBefore(openMoment)) {
                const diff = openMoment.diff(now);
                document.getElementById(countdownId).className = 'closed';
                document.getElementById(countdownId).textContent = formatDuration(diff);
            } else if (now.isBefore(closeMoment)) {
                const diff = closeMoment.diff(now);
                document.getElementById(countdownId).className = 'open';
                document.getElementById(countdownId).textContent = formatDuration(diff);
            } else {
                const nextOpen = getNextTradingDay(now, config);
                const openMomentNext = nextOpen.clone().set({ hour: config.openTime.split(':')[0], minute: config.openTime.split(':')[1], second: 0 });
                const diff = openMomentNext.diff(now);
                document.getElementById(countdownId).className = 'closed';
                document.getElementById(countdownId).textContent = formatDuration(diff);
            }
        }

        async function updateRates() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await res.json();
                document.getElementById('usdhkd').textContent = data.rates.HKD.toFixed(4);
            } catch {
                document.getElementById('usdhkd').textContent = 'N/A';
            }

            try {
                const res = await fetch('https://markets.newyorkfed.org/api/rates/all/latest.xml');
                const xmlText = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                const rates = xml.getElementsByTagName('rate');
                for (let rate of rates) {
                    if (rate.getElementsByTagName('type')[0].textContent === 'EFFR') {
                        const percentRate = parseFloat(rate.getElementsByTagName('percentRate')[0].textContent).toFixed(2);
                        document.getElementById('effr').textContent = percentRate + '%';
                        break;
                    }
                }
            } catch {
                document.getElementById('effr').textContent = 'N/A';
            }

            try {
                const res = await fetch('https://api.hkma.gov.hk/public/market-data-and-statistics/daily-monetary-statistics/daily-figures-interbank-liquidity');
                const data = await res.json();
                const latest = data.result.records[0];
                document.getElementById('hkd_on').textContent = parseFloat(latest.hibor_overnight).toFixed(2) + '%';
                document.getElementById('hkd_1m').textContent = parseFloat(latest.hibor_fixing_1m).toFixed(2) + '%';
            } catch {
                document.getElementById('hkd_on').textContent = 'N/A';
                document.getElementById('hkd_1m').textContent = 'N/A';
            }
        }

        function updateTimers() {
            updateTimer(nyseConfig, 'nyse-countdown');
            updateTimer(lseConfig, 'lse-countdown');
        }

        updateTimers();
        setInterval(updateTimers, 1000);

        updateRates();
        setInterval(updateRates, 3600000); // every 1 hour
    </script>
</body>
</html>
